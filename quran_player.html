<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقع القرآن الكريم - بصوت وليد النايحي</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-bg: #F8F9FA;
            --secondary-bg: #FFFFFF;
            --accent-color: #2E86C1;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --border-color: #DEE2E6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        * { box-sizing: border-box; }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }
        .top-section {
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 20;
            flex-shrink: 0;
        }
        .header {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .header-top-row {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }
        #hizbSelector {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            font-weight: 700;
        }
        #downloadHizbBtn {
            flex-shrink: 0;
            padding: 11px 20px;
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
            background-color: var(--accent-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .search-container {
            width: 100%;
        }
        #searchInput {
            width: 100%;
            padding: 11px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        .athman-list-container {
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
        }
        .athman-list {
            list-style: none;
            padding: 0 10px;
            margin: 0;
            display: inline-flex;
            gap: 10px;
        }
        .athman-list-item {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            min-width: 50px;
            text-align: center;
        }
        .athman-list-item.active {
            background-color: var(--accent-color);
            color: var(--secondary-bg);
            border-color: var(--accent-color);
            font-weight: bold;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto; 
        }
        #quranImage {
            width: auto;
            height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        .player-container {
            background-color: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            padding: 15px 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #currentThumnTitle {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            min-height: 30px; 
        }
        .timeline-container { display: flex; align-items: center; gap: 15px; }
        .time-display { font-size: 0.85rem; }
        .all-controls-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            width: 100%;
            margin-top: 5px;
        }
        .advanced-controls-container-left {
            grid-column: 1 / 2;
            justify-self: start;
            display: flex;
            gap: 20px;
        }
         .advanced-controls-container-right {
             grid-column: 3 / 4;
            justify-self: end;
            display: flex;
            gap: 20px;
        }
        .player-controls {
            grid-column: 2 / 3;
            justify-self: center;
            display: flex;
            gap: 20px;
        }
        .player-controls button {
            background: none; border: none; font-size: 2.2rem;
            cursor: pointer; color: var(--text-primary);
        }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 0.9rem; }
        .control-group select, .control-group input {
            padding: 6px 8px; border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.85rem;
        }
        .control-group input[type="number"] { width: 60px; }

        .loading-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center; align-items: center;
            z-index: 1000;
            font-size: 1.5rem; font-weight: 700;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay"></div>

    <div class="top-section">
        <header class="header">
            <div class="header-top-row">
                <select id="hizbSelector"></select>
                <button id="downloadHizbBtn">تحميل الحزب</button>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="ابحث في جميع الأحزاب...">
            </div>
        </header>
        <div class="athman-list-container">
            <ul class="athman-list" id="athmanList"></ul>
        </div>
    </div>

    <main class="main-content">
        <img id="quranImage" src="https://raw.githubusercontent.com/abuabdalaala/quran_nayhy/main/images/cover.jpg" alt="مصحف القارئ وليد النايحي">
    </main>

    <footer class="player-container">
        <div id="currentThumnTitle">اختر ثمنًا للبدء</div>
        <div class="timeline-container">
            <span class="time-display" id="currentTime">0:00</span>
            <input type="range" id="timeline" value="0" step="1" style="width: 100%;">
            <span class="time-display" id="totalTime">0:00</span>
        </div>
        <div class="all-controls-grid">
            <div class="advanced-controls-container-left">
                <div class="control-group">
                    <label for="speedControl">السرعة:</label>
                    <select id="speedControl">
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>عادية</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                    </select>
                </div>
            </div>
            <div class="player-controls">
                <button id="prevBtn" title="الثمن السابق">⏮</button>
                <button id="playPauseBtn" title="تشغيل/إيقاف">⏯</button>
                <button id="nextBtn" title="الثمن التالي">⏭</button>
            </div>
             <div class="advanced-controls-container-right">
                 <div class="control-group">
                    <label for="repeatCount">التكرار:</label>
                    <input type="number" id="repeatCount" min="1" value="1">
                </div>
            </div>
        </div>
    </footer>

    <audio id="audioPlayer" style="display:none;"></audio>

    <script>
        // DOM Elements
        const hizbSelector = document.getElementById('hizbSelector');
        const athmanList = document.getElementById('athmanList');
        const searchInput = document.getElementById('searchInput');
        const quranImage = document.getElementById('quranImage');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const speedControl = document.getElementById('speedControl');
        const repeatCountInput = document.getElementById('repeatCount');
        const currentThumnTitle = document.getElementById('currentThumnTitle');
        const timeline = document.getElementById('timeline');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const downloadHizbBtn = document.getElementById('downloadHizbBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // GitHub Config
        const GITHUB_USER = "abuabdalaala";
        const GITHUB_REPO = "quran_nayhy";
        const GITHUB_BRANCH = "main";
        const GITHUB_RAW_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/`;

        // Data
        const thumnTitles = [
            "001- الحمد لله رب العالمين", "002- وإذا لقوا الذين آمنوا قالوا آمنا وإذا خلوا إلى شياطينهم قالوا إنا معكم", "003- إن الله لا يستحيي أن يضرب مثلا ما بعوضة فما فوقها", "004- وإذ قلنا للملائكة اسجدوا لآدم فسجدوا إلا إبليس أبى واستكبر", "005- أتأمرون الناس بالبر وتنسون أنفسكم وأنتم تتلون الكتاب", "006- وإذ قال موسى لقومه يا قوم إنكم ظلمتم أنفسكم", "007- وإذ استسقى موسى لقومه فقلنا اضرب بعصاك الحجر", "008- وإذ قال موسى لقومه إن الله يأمركم أن تذبحوا بقرة", "009- وإذا لقوا الذين آمنوا قالوا آمنا وإذا خلا بعضهم إلى بعض قالوا أتحدثونهم", "010- وإن يأتوكم أسارى تفادوهم وهو محرم عليكم إخراجهم",
            "011- ولقد جاءكم موسى بالبينات ثم اتخذتم العجل من بعده وأنتم ظالمون", "012- واتبعوا ما تتلوا الشياطين على ملك سليمان وما كفر سليمان", "013- ما ننسخ من آية أو ننسها نأت بخير منها أو مثلها", "014- ولله المشرق والمغرب فأينما تولوا فثم وجه الله", "015- وإذ ابتلى إبراهيم ربه بكلمات فأتمهن", "016- أم كنتم شهداء إذ حضر يعقوب الموت إذ قال لبنيه", "017- سيقول السفهاء من الناس ما ولاهم عن قبلتهم التي كانوا عليها", "018- ولكل وجهة هو موليها فاستبقوا الخيرات", "019- إن الصفا والمروة من شعائر الله", "020- يا أيها الناس كلوا مما في الأرض حلالا طيبا",
            "021- ليس البر أن تولوا وجوهكم قبل المشرق والمغرب", "022- شهر رمضان الذي أنزل فيه القرءان", "023- يسألونك عن الأهلة قل هي مواقيت للناس والحج", "024- الحج أشهر معلومات فمن فرض فيهن الحج فلا رفث", "025- واذكروا الله في أيام معدودات", "026- كان الناس أمة واحدة فبعث الله النبيئين", "027- يسألونك عن الخمر والميسر قل فيهما إثم كبير", "028- والمطلقات يتربصن بأنفسهن ثلاثة قروء", "029- والوالدات يرضعن أولادهن حولين كاملين", "030- لا جناح عليكم إن طلقتم النساء ما لم تمسوهن",
            "031- ألم تر إلى الذين خرجوا من ديارهم وهم ألوف حذر الموت", "032- وقال لهم نبيئهم إن آية ملكه أن يأتيكم التابوت", "033- تلك الرسل فضلنا بعضهم على بعض", "034- ألم تر إلى الذي حاج إبراهيم في ربه", "035- قول معروف ومغفرة خير من صدقة يتبعها أذى", "036- يا أيها الذين آمنوا أنفقوا من طيبات ما كسبتم", "037- ليس عليك هداهم ولكن الله يهدي من يشاء", "038- يا أيها الذين آمنوا إذا تداينتم بدين إلى أجل مسمى فاكتبوه", "039- وإن كنتم على سفر ولم تجدوا كاتبا فرهان مقبوضة", "040- إن الله لا يخفى عليه شيء في الأرض ولا في السماء",
            "041- قل أؤنبئكم بخير من ذالكم للذين اتقوا عند ربهم جنات", "042- قل اللهم مالك الملك تؤتي الملك من تشاء", "043- إن الله اصطفى آدم ونوحا وآل إبراهيم وآل عمران", "044- وإذ قالت الملائكة يا مريم إن الله اصطفاك", "045- فلما أحس عيسى منهم الكفر قال من أنصاري إلى الله", "046- قل يا أهل الكتاب تعالوا إلى كلمة سواء بيننا وبينكم", "047- ومن أهل الكتاب من إن تأمنه بقنطار يؤده إليك", "048- أفغير دين الله تبغون وله أسلم من في السماوات والأرض", "049- لن تنالوا البر حتى تنفقوا مما تحبون", "050- ولتكن منكم أمة يدعون إلى الخير",
            "051- ليسوا سواء من أهل الكتاب أمة قائمة", "052- وإذ غدوت من أهلك تبوئ المؤمنين مقاعد للقتال", "053- سارعوا إلى مغفرة من ربكم وجنة عرضها السماوات والأرض", "054- وما محمد إلا رسول قد خلت من قبله الرسل", "055- إذ تصعدون ولا تلوون على أحد والرسول يدعوكم في أخراكم", "056- إن ينصركم الله فلا غالب لكم", "057- يستبشرون بنعمة من الله وفضل", "058- ما كان الله ليذر المؤمنين على ما أنتم عليه", "059- لتبلون في أموالكم وأنفسكم ولتسمعن", "060- فاستجاب لهم ربهم أني لا أضيع عمل عامل منكم",
            "061- وابتلوا اليتامى حتى إذا بلغوا النكاح", "062- يوصيكم الله في أولادكم للذكر مثل حظ الأنثيين", "063- تلك حدود الله ومن يطع الله ورسوله ندخله جنات", "064- يا أيها الذين آمنوا لا يحل لكم أن ترثوا النساء كرها", "065- والمحصنات من النساء إلا ما ملكت أيمانكم", "066- إن تجتنبوا كبائر ما تنهون نكفر عنكم سيئاتكم", "067- واعبدوا الله ولا تشركوا به شيئا", "068- يا أيها الذين أوتوا الكتاب آمنوا بما نزلنا مصدقا لما معكم", "069- إن الله يأمركم أن تؤدوا الأمانات إلى أهلها", "070- وما أرسلنا من رسول إلا ليطاع بإذن الله",
            "071- فليقاتل في سبيل الله الذي يشرون الحياة الدنيا بالآخرة", "072- أينما تكونوا يدرككم الموت ولو كنتم في بروج مشيدة", "073- الله لا إله إلا هو ليجمنعكم إلى يوم القيامة لا ريب فيه", "074- ومن يقتل مؤمنا متعمدا فجزاؤه جهنم خالدا فيها", "075- ومن يهاجر في سبيل الله يجد في الأرض مراغما كثيرا وسعة", "076- إنا أنزلنا إليك الكتاب بالحق لتحكم بين الناس بما أراك الله", "077- لا خير في كثير من نجواهم إلا من أمر بصدقة أو معروف", "078- ليس بأمانيكم ولا أماني أهل الكتاب", "079- وإن يتفرقا يغن الله كلا من سعته", "080- بشر المنافقين بأن لهم عذابا أليما",
            "081- لا يحب الله الجهر بالسوء من القول إلا من ظلم", "082- وإن من أهل الكتاب إلا ليؤمنن به قبل موته", "083- لكن الله يشهد بما أنزل إليك أنزله بعلمه", "084- لن يستنكف المسيح أن يكون عبدا لله ولا الملائكة المقربون", "085- حرمت عليكم الميتة والدم ولحم الخنزير وما أهل لغير الله به", "086- يا أيها الذين آمنوا إذا قمتم إلى الصلاة فاغسلوا وجوهكم", "087- ولقد أخذ الله ميثاق بني إسرائيل وبعثنا منهم اثني عشر نقيبا", "088- لقد كفر الذين قالوا إن الله هو المسيح ابن مريم", "089- قال رجلان من الذين يخافون أنعم الله عليهما", "090- من أجل ذلك كتبنا على بني إسرائيل أنه من قتل نفسا",
            "091- يا أيها الرسول لا يحزنك الذين يسارعون في الكفر", "092- وكتبنا عليهم فيها أن النفس بالنفس", "093- وأن احكم بينهم بما أنزل الله ولا تتبع أهواءهم واحذرهم", "094- قل يا أهل الكتاب هل تنقمون منا إلا أن آمنا بالله", "095- يا أيها الرسول بلغ ما أنزل إليك من ربك", "096- ما المسيح ابن مريم إلا رسول قد خلت من قبله الرسل", "097- لتجدن أشد الناس عداوة للذين آمنوا اليهود والذين أشركوا", "098- يا أيها الذين آمنوا إنما الخمر والميسر والأنصاب والأزلام رجس", "099- جعل الله الكعبة البيت الحرام قياما للناس", "100- يا أيها الذين آمنوا شهادة بينكم إذا حضر أحدكم الموت",
            "101- وإذ أوحيت إلى الحواريين أن آمنوا بي وبرسولي", "102- الحمد لله الذي خلق السماوات والأرض وجعل الظلمات والنور", "103- وله ما سكن في الليل والنهار وهو السميع العليم", "104- ومنهم من يستمع إليك وجعلنا على قلوبهم أكنة", "105- إنما يستجيب الذين يسمعون والموتى يبعثهم الله", "106- قل لا أقول لكم عندي خزائن الله ولا أعلم الغيب", "107- وعنده مفاتح الغيب لا يعلمها إلا هو", "108- وذر الذين اتخذوا دينهم لعبا ولهوا وغرتهم الحياة الدنيا", "109- وحاجه قومه قال أتحاجوني في الله وقد هدان", "110- وما قدروا الله حق قدره إذ قالوا ما أنزل الله على بشر من شيء",
            "111- إن الله فالق الحب والنوى يخرج الحي من الميت", "112- وجعلوا لله شركاء الجن وخلقهم", "113- ولو أننا نزلنا إليهم الملائكة وكلمهم الموتى", "114- وذروا ظاهر الإثم وباطنه", "115- لهم دار السلام عند ربهم وهو وليهم", "116- وجعلوا لله مما ذرأ من الحرث والأنعام نصيبا", "117- وهو الذي أنشأ جنات معروشات وغير معروشات", "118- قل لا أجد في ما أوحي إلي محرما على طاعم يطعمه إلا أن يكون", "119- قل تعالوا أتلو ما حرم ربكم عليكم", "120- هل ينظرون إلا أن تأتيهم الملائكة أو يأتي ربك",
            "121- ألمص كتاب أنزل إليك فلا يكن في صدرك حرج منه", "122- ويا آدم اسكن أنت وزوجك الجنة", "123- قل أمر ربي بالقسط وأقيموا وجوهكم عند كل مسجد", "124- قال ادخلوا في أمم قد خلت من قبلكم من الجن والإنس في النار", "125- وإذا صرفت أبصارهم تلقا أصحاب النار", "126- ادعوا ربكم تضرعا وخفية إنه لا يحب المعتدين", "127- وإلى عاد أخاهم هودا قال يا قوم اعبدوا الله", "128- قال الملأ الذين استكبروا من قومه للذين استضعفوا", "129- قال الملأ الذين استكبروا من قومه لنخرجنك يا شعيب", "130- أولم يهد للذين يرثون الأرض من بعد أهلها",
            "131- وأوحينا إلى موسى أن ألق عصاك", "132- وقالوا مهما تأتنا به من آية لتسحرنا بها فما نحن لك بمؤمنين", "133- وواعدنا موسى ثلاثين ليلة وأتممناها بعشر", "134- واتخذ قوم موسى من بعده من حليهم عجلا جسدا له خوار", "135- واكتب لنا في هذه الدنيا حسنة وفي الآخرة إنا هدنا إليك", "136- وسئلهم عن القرية التي كانت حاضرة البحر", "137- وإذ نتقنا الجبل فوقهم كأنه ظلة", "138- ولله الأسماء الحسنى فادعوه بها", "139- قل لا أملك لنفسي نفعا ولا ضرا إلا ما شاء الله", "140- خذ العفو وأمر بالعرف وأعرض عن الجاهلين",
            "141- كما أخرجك ربك من بيتك بالحق وإن فريقا من المؤمنين لكارهون", "142- إذ يوحي ربك إلى الملائكة أني معكم فثبتوا الذين آمنوا", "143- إن شر الدواب عند الله الصم البكم الذين لا يعقلون", "144- وإذ قالوا اللهم إن كان هذا هو الحق من عندك فأمطر علينا حجارة", "145- واعلموا أنما غنمتم من شيء فأن لله خمسه وللرسول", "146- إذ يقول المنافقون والذي في قلوبهم مرض غر هؤلاء دينهم", "147- وأعدوا لهم ما استطعتم من قوة ومن رباط الخيل", "148- إن الذين آمنوا وهاجروا وجاهدوا بأموالهم وأنفسهم", "149- فإذا انسلخ الأشهر الحرم فاقتلوا المشركين حيث وجدتموهم", "150- وإن نكثوا أيمانهم من بعد عهدهم وطعنوا في دينكم",
            "151- أجعلتم سقاية الحاج وعمارة المسجد الحرام كمن آمن بالله", "152- لقد نصركم الله في مواطن كثيرة ويوم حنين", "153- يا أيها الذين آمنوا إن كثيرا من الأحبار والرهبان ليأكلون أموال", "154- إلا تنصروه فقد نصره الله", "155- ولو أرادوا الخروج لأعدوا له عدة", "156- وما منعهم أن تقبل منهم نفقاتهم إلا أنهم كفروا", "157- ومنهم الذين يؤذون النبيء ويقولون هو أذن", "158- ألم يأتهم نبأ الذين من قبلهم قوم نوح وعاد وثمود", "159- ومنهم من عاهد الله لئن آتانا من فضله لنصدقن", "160- ولا تصل على أحد منهم مات أبدا ولا تقم على قبره",
            "161- إنما السبيل على الذين يستأذنونك وهم أغنياء", "162- وممن حولكم من الأعراب منافقون ومن أهل المدينة", "163- إن الله اشترى من المؤمنين أنفسهم وأموالهم بأن لهم الجنة", "164- لقد تاب الله على النبيء والمهاجرين والأنصار الذين اتبعوه", "165- يا أيها الذين ءامنوا قاتلوا الذين يلونكم من الكفار", "166- إن ربكم الله الذي خلق السماوات والأرض في ستة أيام", "167- ولو يعجل الله للناس الشر استعجالهم بالخير لقضي إليهم أجلهم", "168- وما كان الناس إلا أمة واحدة فاختلفوا", "169- للذين أحسنوا الحسنى وزيادة", "170- وما كان هذا القرآن أن يفترى من دون الله",
            "171- قل لا أملك لنفسي ضرا ولا نفعا إلا ما شاء الله", "172- وما تكون في شأن وما تتلوا منه من قرآن", "173- واتل عليهم نبأ نوح إذ قال لقومه يا قوم إن كان كبر عليكم مقامي", "174- فما آمن لموسى إلا ذرية من قومه على خوف من فرعون", "175- ولقد بوأنا بني إسرائيل مبوأ صدق ورزقناهم من الطيبات", "176- قل يا أيها الناس إن كنتم في شك من ديني", "177- وما من دابة في الأرض إلا على الله رزقها", "178- من كان يريد الحياة الدنيا وزينتها نوف إليهم أعمالهم فيها", "179- مثل الفريقين كالأعمى والأصم والبصير السميع", "180- قالوا يا نوح قد جادلتنا فأكثرت جدالنا فأتنا بما تعدنا",
            "181- وقال اركبوا فيها بسم الله مجراها ومرساها", "182- وإلى عاد أخاهم هودا قال يا قوم اعبدوا الله", "183- قالوا يا صالح قد كنت فينا مرجوا قبل هذا", "184- فلما ذهب عن إبراهيم الروع وجاءته البشرى", "185- وإلى مدين أخاهم شعيبا قال يا يقوم اعبدوا الله", "186- ولما جا أمرنا نجينا شعيبا والذين آمنوا معه", "187- يوم يأتي لا تكلم نفس إلا بإذنه", "188- وكلا نقص عليك من أنباء الرسل ما نثبت به فؤادك", "189- قال قآئل منهم لا تقتلوا يوسف وألقوه في غيابات الجب", "190- ولما بلغ أشده آتيناه حكما وعلما",
            "191- قال رب السجن أحب إلي مما يدعونني إليه", "192- وقال الملك إني أرى سبع بقرات سمان", "193- وما أبرئ نفسي إن النفس لأمارة بالسوء إلا ما رحم ربي", "194- وقال يا بني لا تدخلوا من باب واحد وادخلوا من أبواب متفرقة", "195- قالوا إن يسرق فقد سرق أخ له من قبل", "196- فلما دخلوا عليه قالوا يا أيها العزيز مسنا وأهلنا الضر", "197- رب قد آتيتني من الملك وعلمتني من تأويل الأحاديث", "198- حتى إذا استيأس الرسل وظنوا أنهم قد كذبوا", "199- وإن تعجب فعجب قولهم", "200- قل من رب السماوات والأرض قل الله",
            "201- أفمن يعلم أنما أنزل إليك من ربك الحق كمن هو أعمى", "202- كذلك أرسلناك في أمة قد خلت من قبلها أمم", "203- مثل الجنة التي وعد المتقون تجري من تحتها الأنهار", "204- ألر كتاب أنزلناه إليك لتخرج الناس من الظلمات إلى النور", "205- قالت رسلهم أفي الله شك فاطر السماوات والأرض", "206- ألم تر أن الله خلق السماوات والأرض بالحق", "207- ألم تر إلى الذين بدلوا نعمة الله كفرا", "208- الحمد لله الذي وهب لي على الكبر إسماعيل وإسحاق", "209- ألر تلك آيات الكتاب وقرآن مبين ربما يود الذين كفروا", "210- ولقد خلقنا الإنسان من صلصال من حمإ مسنون",
            "211- نبئ عبادي أني أنا الغفور الرحيم", "212- ولقد كذب أصحاب الحجر المرسلين", "213- أتى أمر الله فلا تستعجلوه", "214- وألقى في الأرض رواسي أن تميد بكم", "215- وقيل للذين اتقوا ماذا أنزل ربكم", "216- وأقسموا بالله جهد أيمانهم لا يبعث الله من يموت", "217- وقال الله لا تتخذوا إلهين اثنين إنما هو إله واحد", "218- تالله لقد أرسلنا إلى أمم من قبلك فزين لهم الشيطان أعمالهم", "219- والله فضل بعضكم على بعض في الرزق", "220- ألم يروا إلى الطير مسخرات في جو السماء",
            "221- إن الله يأمر بالعدل والإحسان وإيتاء ذي القربى", "222- فإذا قرأت القرآن فاستعذ بالله من الشيطان الرجيم", "223- يوم تأتي كل نفس تجادل عن نفسها", "224- إن إبراهيم كان أمة قانتا لله حنيفا ولم يك من المشركين", "225- سبحان الذي أسرى بعبده ليلا", "226- ويدع الإنسان بالشر دعاءه بالخير", "227- وقضى ربك ألا تعبدوا إلا إياه وبالوالدين إحسانا", "228- ولا تقف ما ليس لك به علم", "229-قل كونوا حجارة أو حديدا", "230- وإذ قلنا للملائكة اسجدوا لآدم فسجدوا إلا إبليس قال أأسجد",
            "231- ولقد كرمنا بني آدم وحملناهم في البر والبحر", "232- ويسألونك عن الروح قل الروح من أمر ربي", "233- أولم يروا أن الله الذي خلق السماوات والأرض قادر", "234- الحمد لله الذي أنزل على عبده الكتاب ولم يجعل له عوجا", "235- وترى الشمس إذا طلعت تزاور عن كهفهم ذات اليمين", "236- فلا تمار فيهم إلا مراء ظاهرا", "237- واضرب لهم مثلا رجلين جعلنا لأحدهما جنتين", "238- واضرب لهم مثل الحياة الدنيا كماء أنزلناه من السماء", "239- ولقد صرفنا في هذا القرآن للناس من كل مثل", "240- قال ذلك ما كنا نبغ فارتدا على آثارهما قصصا",
            "241- قال ألم أقل لك إنك لن تستطيع معي صبرا", "242- ويسألونك عن ذي القرنين قل سأتلوا عليكم منه ذكرا", "243- وتركنا بعضهم يومئذ يموج في بعض", "244- كهيعص ذكر رحمة ربك عبده زكرياء", "245- فحملته فانتبذت به مكانا قصيا", "246- واذكر في الكتاب إبراهيم إنه كان صديقا نبيئا", "247- فخلف من بعدهم خلف أضاعوا الصلاة واتبعوا الشهوات", "248- أفرأيت الذي كفر بآياتنا وقال لأوتين مالا وولدا", "249- طه ما أنزلنا عليك القرآن لتشقى", "250- قال رب اشرح لي صدري",
            "251- منها خلقناكم وفيها نعيدكم ومنها نخرجكم تارة أخرى", "252- قالوا لن نؤثرك على ما جاءنا من البينات", "253- وما أعجلك عن قومك يا موسى", "254- قال فما خطبك يا سامري", "255- وعنت الوجوه للحي القيوم وقد خاب من حمل ظلما", "256- أفلم يهد لهم كم أهلكنا قبلهم من القرون", "257- اقترب للناس حسابهم وهم في غفلة معرضون", "258- وما خلقنا السماء والأرض وما بينهما لاعبين", "259- أولم ير الذين كفروا أن السماوات والأرض كانتا رتقا ففتقناهما", "260- قل من يكلؤكم بالليل والنهار من الرحمن",
            "261- ولقد آتينا إبراهيم رشده من قبل", "262- ولوطا آتيناه حكما وعلما", "263- وذا النون إذ ذهب مغاضبا فظن أن لن نقدر عليه", "264- إن الذين سبقت لهم منا الحسنى", "265- يا أيها الناس اتقوا ربكم إن زلزلة الساعة شيء عظيم", "266- ومن الناس من يعبد الله على حرف", "267- هذان خصمان اختصموا في ربهم", "268- ذلك ومن يعظم حرمات الله فهو خير له", "269- إن الله يدافع عن الذين آمنوا", "270- قل يا أيها الناس إنما أنا لكم نذير مبين",
            "271- ذلك ومن عاقب بمثل ما عوقب به", "272- ألم تعلم أن الله يعلم ما في السماء والأرض", "273- قد أفلح المؤمنون", "274- وإن لكم في الأنعام لعبرة", "275- هيهات هيهات لما توعدون", "276- إن الذين هم من خشية ربهم مشفقون", "277- ولو رحمناهم وكشفنا ما بهم من ضر", "278- وقل رب أعوذ بك من همزات الشياطين", "279- أفحسبتم أنما خلقناكم عبثا وأنكم إلينا لا ترجعون", "280- إن الذين جاءوا بالإفك عصبة منكم",
            "281- يا أيها الذين آمنوا لا تتبعوا خطوات الشيطان", "282- قل للمؤمنين يغضوا من أبصارهم ويحفظوا فروجهم", "283- الله نور السماوات والأرض", "284- ألم تر أن الله يزجي سحابا ثم يؤلف بينه", "285- وأقسموا بالله جهد أيمانهم لئن أمرتهم ليخرجن", "286- والقواعد من النساء اللاتي لا يرجون نكاحا", "287- لا تجعلوا دعاء الرسول بينكم كدعاء بعضكم بعضا", "288- تبارك الذي إن شاء جعل لك خيرا من ذلك", "289- وقال الذين لا يرجون لقاءنا لولا أنزل علينا الملائكة", "290- وقال الذين كفروا لولا نزل عليه القرآن جملة",
            "291- ألم تر إلى ربك كيف مد الظل", "292- تبارك الذي جعل في السماء بروجا", "293- طسم تلك آيات الكتاب المبين لعلك باخع نفسك", "294- قال فرعون وما رب العالمين", "295- قالوا لا ضير إنا إلى ربنا منقلبون", "296- الذي خلقني فهو يهدين", "297- قالوا أنؤمن لك واتبعك الأرذلون", "298- أتتركون في ما هاهنا آمنين", "299- أوفوا الكيل ولا تكونوا من المخسرين", "300- وما أهلكنا من قرية إلا لها منذرون",
            "301- وإنك لتلقى القرآن من لدن حكيم عليم", "302- حتى إذ أتوا على واد النمل قالت نملة", "303- قال سننظر أصدقت أم كنت من الكاذبين", "304- قال نكروا لها عرشها", "305- قل الحمد لله وسلام على عباده الذين اصطفى", "306- وقال الذين كفروا إذا كنا ترابا وآباؤنا", "307- وإذا وقع القول عليهم أخرجنا لهم دابة من الأرض", "308-  طسم تلك آيات الكتاب المبين نتلو عليك من نبإ موسى", "309- وحرمنا عليه المراضع من قبل", "310- وجاء رجل من أقصا المدينة يسعى قال يا موسى",
            "311- فلما قضى موسى الأجل وسار بأهله", "312- وقال فرعون يا أيها الملأ ما علمت لكم من إله غيري", "313- ولقد وصلنا لهم القول لعلهم يذكرون", "314- أفمن وعدناه وعدا حسنا فهو لاقيه", "315-  إن قارون كان من قوم موسى فبغى عليهم", "316- تلك الدار الآخرة نجعلها للذين لا يريدون علوا في الأرض و لا فسادا", "317- ووصينا الإنسان بوالديه حسنا وإن جاهداك على أن تشرك بي", "318- وإبراهيم إذ قال لقومه اعبدوا الله واتقوه", "319- فآمن له لوط", "320- وإلى مدين أخاهم شعيبا",
            "321- ولا تجادلوا أهل الكتاب إلا بالتي هي أحسن", "322- وكأين من دابة لا تحمل رزقها الله يرزقها وإياكم", "323- أولم يسيروا في الأرض فينظروا كيف كان عاقبة الذين من قبلهم", "324- ومن آياته خلق السماوات والأرض واختلاف ألسنتكم", "325- منيبين إليه واتقوه وأقيموا الصلاة", "326- ظهر الفساد في البر والبحر بما كسبت أيدي الناس", "327- الله الذي خلقكم من ضعف ثم جعل من بعد ضعف قوة", "328- ولقد آتينا لقمان الحكمة أن أشكر لله", "329- ومن يسلم وجهه لله وهو محسن", "330- وإذ غشيهم موج كالظلل دعوا الله",
            "331- قل يتوفاكم ملك الموت الذي وكل بكم", "332- ولقد آتينا موسى الكتاب فلا تكن في مرية من لقائه", "333- النبيء أولى بالمؤمنين من أنفسهم", "334- وإذ قالت طائفة منهم يا أهل يثرب لا مقام لكم", "335- يحسبون الأحزاب لم يذهبوا", "336- يا أيها النبيء قل لأزواجك إن كنتن تردن الحياة الدنيا", "337- إن المسلمين والمسلمات والمؤمنين والمؤمنات", "338- ما كان محمد أبا أحد من رجالكم", "339- ترجي من تشاء منهن وتؤوي إليك من تشاء", "340- لا جناح عليهن في آباءهن ولا أبنائهن ولا إخوانهن",
            "341- لئن لم ينته المنافقون والذين في قلوبهم مرض", "342- إنا عرضنا الأمانة على السماوات والأرض والجبال", "343- وقال الذين كفروا هل ندلكم على رجل", "344- لقد كان لسبإ في مساكنهم آية", "345- قل من يرزقكم من السماوات والأرض قل الله", "346- وما أرسلنا في قرية من نذير إلا قال مترفوها", "347- قل إنما أعظكم بواحدة", "348- يا أيها الناس إن وعد الله حق", "349- يا أيها الناس أنتم الفقراء إلى الله", "350- والذي أوحينا إليك من الكتاب هو الحق",
            "351- قل أرأيتم شركاءكم الذين تدعون من دون الله", "352- يس والقرآن الحكيم", "353- وما أنزلنا على قومه من بعده من جند من السماء", "354- وإذا قيل لهم اتقوا ما بين أيديكم وما خلفكم لعلكم ترحمون", "355- ألم أعهد إليكم يا بني آدم ألا تعبدوا الشيطان", "356- أولم ير الإنسان أنا خلقناه من نطفة", "357- احشروا الذين ظلموا وأزواجهم وما كانوا يعبدون", "358- قال قائل منهم إني كان لي قرين", "359- وإن من شيعته لإبراهيم", "360- ولقد مننا على موسى وهارون",
            "361- فنبذناه بالعراء وهو سقيم", "362- ص والقرآن ذي الذكر", "363- وهل أتاك نبأ الخصم إذ تسورا المحراب", "364- ووهبنا لداوود سليمان", "365- وعندهم قاصرات الطرف أتراب", "366- قال فالحق والحق أقول", "367- وإذ مس الإنسان ضر دعا ربه منيبا إليه", "368- أفمن حق عليه كلمة العذاب", "369- فمن أظلم ممن كذب على الله وكذب بالصدق", "370- أم اتخذوا من دون الله شفعاء",
            "371- قل يا عبادي الذي أسرفوا على أنفسهم", "372- وما قدروا الله حق قدره والأرض جميعا قبضته", "373- حم تنزيل الكتاب من الله العزيز العليم غافر الذنب", "374- إن الذين كفروا ينادون لمقت الله أكبر من مقتكم أنفسكم", "375- أولم يسيروا في الأرض فينظروا كيف كان عاقبة الذين كانوا", "376- وقال الذي آمن يا قوم إني أخاف عليكم مثل يوم الأحزاب", "377- ويا قومي مالي أدعوكم إلى النجاة وتدعونني إلى النار", "378- ولقد آتينا موسى الهدى وأورثنا بني إسرائيل الكتاب", "379- قل إني نهيت أن أعبد الذي تدعون من دون الله", "380- الله الذي جعل لكم الأنعام لتركبوا منها ومنها تأكلون",
            "381- قل أإنكم لتكفرون بالذي خلق الأرض في يومين", "382- وأما ثمود فهديناهم فاستحبوا العمى على الهدى", "383- وقال الذين كفروا لا تسمعوا لهذا القرآن والغوا فيه", "384- فإن استكبروا فالذين عند ربك يسبحون له بالليل والنهار", "385- إليه يرد علم الساعة", "386- حم عسق كذلك يوحي إليك وإلى الذين من قبلك الله العزيز الحكيم", "387- شرع لكم من الدين ما وصى به نوحا", "388- أم لهم شركاء شرعوا لهم من الدين ما لم يأذن به الله", "389- أو يوبقهن بما كسبوا ويعف عن كثير", "390- ولمن صبر وغفر إن ذلك لمن عزم الأمور",
            "391- وما كان لبشر أن يكلمه الله إلا وحيا أو من وراء حجاب", "392- والذي خلق الأزواج كلها وجعل لكم من الفلك والأنعام ما تركبون", "393- قل أولو جئتكم بأهدى مما وجدتم عليه آباءكم", "394- فاستمسك بالذي أوحي إليك", "395- ولما جاء عيسى بالبينات قال قد جئتكم بالحكمة", "396- وهو الذي في السماء إله وفي الأرض إله", "397- كم تركوا من جنات وعيون  وزروع ومقام كريم", "398- إن المتقين في مقام أمين", "399- هذا هدى والذين كفروا بآيات ربهم لهم عذاب من رجز أليم", "400- أفرأيت من اتخذ إلهه هواه وأضله الله على علم",
            "401- حم تنزيل الكتاب من الله العزيز الحكيم", "402- ووصينا الإنسان بوالديه حسنا", "403- واذكر أخا عاد إذ أنذر قومه بالأحقاف", "404- أولم يروا أن الله الذي خلق السماوات والأرض ولم يعي بخلقهن", "405- أفلم يسيروا في الأرض فينظروا كيف كان عاقبة الذين من قبلهم", "406- ويقول الذين آمنوا لولا نزلت سورة", "407- يا أيها الذين آمنوا أطيعوا الله وأطيعوا الرسول ولا تبطلوا أعمالكم", "408- إنا أرسلناك شاهدا ومبشرا ونذيرا", "409- لقد رضي الله عن المؤمنين إذ يبايعونك تحت الشجرة", "410- لقد صدق الله رسوله الرؤيا بالحق",
            "411- يا أيها الذين آمنوا لا تقدموا بين يدي الله ورسوله", "412- وإن طائفتان من المؤمنين اقتتلوا", "413- قالت الأعراب آمنا", "414- أفلم ينظروا إلى السماء فوقهم", "415- قال قرينه ربنا ما أطغيته", "416- والذاريات ذروا", "417- قال فما خطبكم أيها المرسلون", "418- وما خلقت الجن والإنس إلا ليعبدون", "419- ويطوف عليهم غلمان لهم كأنهم لؤلؤ مكنون", "420- وإن يروا كسفا من السماء ساقطا",
            "421- وكم من ملك في السماوات لا تغني شفاعتهم شيئا", "422- هذا نذير من النذر الأولى", "423- كذبت عاد فكيف كان عذابي ونذر", "424- ولقد جا آل فرعون النذر", "425- الرحمن علم القرآن", "426- يا معشر الجن والإنس إن استطعتم أن تنفذوا", "427- هل جزاء الإحسان إلا الإحسان", "428- وأصحاب اليمين", "429- فلا أقسم بمواقع النجوم", "430- آمنوا بالله ورسوله وأنفقوا مما جعلكم مستخلفين فيه",
            "431- ألم يأن للذين آمنوا أن تخشع قلوبهم", "432- ما أصاب من مصيبة في الأرض ولا في أنفسكم إلا في كتاب", "433- قد سمع الله قول التي تجادلك في زوجها", "434- ألم تر إلى الذين نهوا عن النجوى", "435- ألم تر إلى الذين تولوا قوما غضب الله عليهم", "436- سبح لله ما في السماوات وما في الأرض وهو العزيز الحكيم", "437- ألم تر إلى الذين نافقوا يقولون لإخوانهم الذين كفروا", "438- يا أيها الذين آمنوا لا تتخذوا عدوي وعدوكم أولياء", "439- عسى الله أن يجعل بينكم وبين الذين عاديتم منهم مودة", "440- سبح لله ما في السماوات وما في الأرض وهو العزيز الحكيم",
            "441- يسبح لله ما في السماوات وما في الأرض الملك القدوس", "442- يا أيها الذين آمنوا إذا نودي للصلاة من يوم الجمعة", "443- يا أيها الذين آمنوا لا تلهكم أموالكم ولا أولادكم", "444- زعم الذين كفروا أن لن يبعثوا قل بلى وربي لتبعثن", "445- يا أيها الذين آمنوا إن من أزواجكم وأولادكم عدوا لكم", "446- اسكنوهن من حيث سكنتم من وجدتكم", "447- الله الذي خلق سبع سماوات ومن الأرض مثلهن", "448- يا أيها الذين آمنوا توبوا إلى الله", "449- تبارك الذي بيده الملك", "450- ألم يروا إلى الطير فوقهم صافات",
            "451- فطاف عليها طائف من ربك", "452- الحاقة ما الحاقة", "453- فلا أقسم بما تبصرون وما لا تبصرون", "454- إن الإنسان خلق هلوعا", "455- فلا أقسم برب المشارق والمغارب", "456- ألم تر كيف خلق الله سبع سماوات طباقا", "457- قل أوحي إلى أنه استمع نفر من الجن", "458- وأن المساجد لله فلا تدعو مع الله أحدا", "459- إن ربك يعلم أنك تقوم أدنى من ثلي الليل", "460- وما جعلنا أصحاب النار إلا ملائكة",
            "461- لا أقسم بيوم القيامة", "462- هل أتى على الإنسان حين من الدهر", "463- ويطوف عليهم ولدان مخلدون", "464 - ألم نهلك الأولين", "465- عم يتساءلون", "466 - والنازعات غرقا", "467- يسألونك عن الساعة أيان مرساها", "468- فإذا جاءت الصاخة", "469- فلا أقسم بالخنس", "470- كلا إن كتاب الفجار لفي سجين",
            "471- فلا أقسم بالشفق", "472- إن بطش ربك لشديد", "473- سبح اسم ربك الأعلى", "474- أفلا ينظرون إلى الإبل كيف خلقت", "475- لا أقسم بهذا البلد", "476- والليل إذا يغشى", "477- ألم نشرح لك صدرك", "478- إنا أنزلناه في ليلة القدر", "479- أفلا يعلم إذا بعثر ما في القبور", "480- ألم تر كيف فعل ربك بأصحاب الفيل"
        ];
        
        const quranData = [];
        for (let i = 0; i < 60; i++) {
            const hizbAthman = [];
            for (let j = 0; j < 8; j++) {
                const thumnIndex = i * 8 + j;
                const title = thumnTitles[thumnIndex] || `الثمن ${thumnIndex + 1}`;
                hizbAthman.push({
                    title: title,
                    audio_file: `thumn_${String(thumnIndex + 1).padStart(3, '0')}.mp3`,
                    image_file: `thumn_${String(thumnIndex + 1).padStart(3, '0')}.jpg`
                });
            }
            const hizbName = thumnTitles[i * 8] ? `${String(i + 1).padStart(2, '0')}- ${thumnTitles[i * 8].substring(0, 40)}...` : `الحزب ${String(i + 1).padStart(2, '0')}`;
            quranData.push({
                hizb_number: i + 1,
                hizb_name: hizbName,
                athman: hizbAthman
            });
        }

        // State
        let currentHizbIndex = 0;
        let currentThumnIndex = -1;
        let isPlaying = false;
        
        function populateHizbSelector() {
            hizbSelector.innerHTML = '';
            quranData.forEach((hizb, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = hizb.hizb_name;
                hizbSelector.appendChild(option);
            });
            hizbSelector.value = currentHizbIndex;
        }
        
        function populateAthmanListForHizb(hizbIndex) {
            const hizb = quranData[hizbIndex];
            athmanList.innerHTML = '';
            hizb.athman.forEach((thumn, thumnIndex) => {
                const li = document.createElement('li');
                li.className = 'athman-list-item';
                li.dataset.hizbIndex = hizbIndex;
                li.dataset.thumnIndex = thumnIndex;
                const globalThumnNumber = hizbIndex * 8 + thumnIndex + 1;
                li.textContent = String(globalThumnNumber).padStart(3, '0');
                li.title = thumn.title;
                
                li.addEventListener('click', () => {
                    if (currentHizbIndex !== hizbIndex || currentThumnIndex !== thumnIndex) {
                        currentHizbIndex = hizbIndex;
                        currentThumnIndex = thumnIndex;
                        loadThumn(true);
                    }
                });
                athmanList.appendChild(li);
            });
            updateActiveListItem();
        }

        function loadThumn(playImmediately = false) {
            if (currentHizbIndex < 0 || currentThumnIndex < 0) return;
            
            const hizb = quranData[currentHizbIndex];
            const thumn = hizb.athman[currentThumnIndex];

            if (searchInput.value === '') { 
                populateAthmanListForHizb(currentHizbIndex);
            }
            currentThumnTitle.textContent = thumn.title;
            
            const audioPath = `audio/${encodeURIComponent(thumn.audio_file)}`;
            const imagePath = `images/${encodeURIComponent(thumn.image_file)}`;

            audioPlayer.src = GITHUB_RAW_BASE_URL + audioPath;
            quranImage.src = GITHUB_RAW_BASE_URL + imagePath;
            
            quranImage.onerror = () => {
                quranImage.src = 'https://via.placeholder.com/1200x1800/FFFFFF/2E86C1?text=خطأ+في+تحميل+الصورة';
            };

            if (playImmediately) {
                audioPlayer.play().catch(e => {
                    console.error("Audio Playback Error:", e);
                    currentThumnTitle.textContent = "خطأ: لم يتم العثور على الملف الصوتي";
                });
            }
        }

        function handleSearch(query) {
            athmanList.innerHTML = '';
            if (!query) {
                populateAthmanListForHizb(currentHizbIndex);
                return;
            }
            quranData.forEach((hizb, hizbIndex) => {
                hizb.athman.forEach((thumn, thumnIndex) => {
                    if (thumn.title.toLowerCase().includes(query.toLowerCase())) {
                        const li = document.createElement('li');
                        li.className = 'athman-list-item';
                        // Displaying a snippet of the title in search results
                        li.textContent = `(${hizb.hizb_number}) ${thumn.title.substring(0, 25)}...`;
                        li.title = thumn.title;
                        li.addEventListener('click', () => {
                            currentHizbIndex = hizbIndex;
                            currentThumnIndex = thumnIndex;
                            hizbSelector.value = hizbIndex;
                            searchInput.value = '';
                            loadThumn(true);
                        });
                        athmanList.appendChild(li);
                    }
                });
            });
        }
        
        function updateActiveListItem() {
            const listItems = athmanList.querySelectorAll('.athman-list-item');
            listItems.forEach(item => {
                const hizbIdx = parseInt(item.dataset.hizbIndex);
                const thumnIdx = parseInt(item.dataset.thumnIndex);
                if (hizbIdx === currentHizbIndex && thumnIdx === currentThumnIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function formatTime(seconds) {
            if(isNaN(seconds)) return "0:00";
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        async function downloadHizbAsZip() {
            loadingOverlay.textContent = "جاري تحضير الملفات...";
            loadingOverlay.style.display = 'flex';
            
            const hizb = quranData[currentHizbIndex];
            const zip = new JSZip();
            
            try {
                // Using a traditional for loop to download sequentially to avoid overwhelming the browser
                for (const thumn of hizb.athman) {
                     loadingOverlay.textContent = `جاري تحميل: ${thumn.title.substring(0,20)}...`;
                     const url = `${GITHUB_RAW_BASE_URL}audio/${encodeURIComponent(thumn.audio_file)}`;
                     const response = await fetch(url);
                     if (!response.ok) throw new Error(`Failed to fetch ${thumn.audio_file}`);
                     const blob = await response.blob();
                     // Sanitize the title to create a valid filename
                     const cleanTitle = thumn.title.replace(/[\\/:*?"<>|]/g, '');
                     zip.file(`${cleanTitle}.mp3`, blob);
                }
                
                loadingOverlay.textContent = "جاري ضغط الملفات...";
                const content = await zip.generateAsync({type:"blob"});
                const cleanHizbName = hizb.hizb_name.replace(/[\\/:*?"<>|]/g, '');
                saveAs(content, `${cleanHizbName}.zip`);
                loadingOverlay.textContent = "اكتمل التحميل!";
            } catch (error) {
                loadingOverlay.textContent = "حدث خطأ أثناء تحميل الملفات.";
                console.error(error);
            } finally {
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 2000);
            }
        }

        // --- Event Listeners ---
        hizbSelector.addEventListener('change', (e) => {
            searchInput.value = '';
            currentHizbIndex = parseInt(e.target.value);
            currentThumnIndex = -1; 
            currentThumnTitle.textContent = 'اختر ثمنًا من الشريط أعلاه';
            populateAthmanListForHizb(currentHizbIndex);
        });
        
        searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
        downloadHizbBtn.addEventListener('click', downloadHizbAsZip);

        playPauseBtn.addEventListener('click', () => {
            if (currentThumnIndex < 0 && quranData[currentHizbIndex].athman.length > 0) { 
                currentThumnIndex = 0;
                loadThumn(true);
                return;
            }
            if (audioPlayer.paused) { audioPlayer.play(); } else { audioPlayer.pause(); }
        });
        
        audioPlayer.addEventListener('play', () => { isPlaying = true; playPauseBtn.textContent = '⏸'; });
        audioPlayer.addEventListener('pause', () => { isPlaying = false; playPauseBtn.textContent = '⏯'; });
        
        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                timeline.value = audioPlayer.currentTime;
                currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            }
        });
        audioPlayer.addEventListener('loadedmetadata', () => {
             timeline.max = audioPlayer.duration;
             totalTimeEl.textContent = formatTime(audioPlayer.duration);
        });

        timeline.addEventListener('input', () => { audioPlayer.currentTime = timeline.value; });

        function playNext() {
            currentThumnIndex++;
            if (currentThumnIndex >= quranData[currentHizbIndex].athman.length) {
                currentHizbIndex++;
                if (currentHizbIndex >= quranData.length) {
                    currentHizbIndex = 0; 
                }
                currentThumnIndex = 0;
                hizbSelector.value = currentHizbIndex;
            }
            loadThumn(isPlaying);
        }

        function playPrev() {
            currentThumnIndex--;
            if (currentThumnIndex < 0) {
                currentHizbIndex--;
                if (currentHizbIndex < 0) {
                    currentHizbIndex = quranData.length - 1; 
                }
                currentThumnIndex = quranData[currentHizbIndex].athman.length - 1;
                hizbSelector.value = currentHizbIndex;
            }
            loadThumn(isPlaying);
        }

        nextBtn.addEventListener('click', playNext);
        prevBtn.addEventListener('click', playPrev);
        speedControl.addEventListener('change', (e) => audioPlayer.playbackRate = parseFloat(e.target.value));
        audioPlayer.addEventListener('ended', () => {
            let repeatCount = parseInt(repeatCountInput.value, 10);
            if (repeatCount > 1) {
                repeatCountInput.value = repeatCount - 1;
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                repeatCountInput.value = 1;
                playNext();
            }
        });
        
        // --- Initial Load ---
        function init() {
            populateHizbSelector();
            populateAthmanListForHizb(currentHizbIndex);
        }

        init();
    </script>
</body>
</html>
