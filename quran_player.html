<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقع القرآن الكريم - بصوت وليد النايحي</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-bg: #F8F9FA;
            --secondary-bg: #FFFFFF;
            --accent-color: #2E86C1;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --border-color: #DEE2E6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        * { box-sizing: border-box; }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }
        .top-section {
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 20;
            flex-shrink: 0;
        }
        .header {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .header-top-row {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }
        #hizbSelector {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            font-weight: 700;
        }
        #downloadHizbBtn {
            flex-shrink: 0;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
            background-color: var(--accent-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .search-container {
            width: 100%;
        }
        #searchInput {
            width: 100%;
            padding: 11px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        .athman-list-container {
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
        }
        .athman-list {
            list-style: none;
            padding: 0 10px;
            margin: 0;
            display: inline-flex;
            gap: 10px;
        }
        .athman-list-item {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .athman-list-item.active {
            background-color: var(--accent-color);
            color: var(--secondary-bg);
            border-color: var(--accent-color);
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto; 
        }
        #quranImage {
            width: auto;
            height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        .player-container {
            background-color: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            padding: 15px 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #currentThumnTitle {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
        }
        .timeline-container { display: flex; align-items: center; gap: 15px; }
        .time-display { font-size: 0.85rem; }
        .all-controls-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* Left, Center, Right */
            align-items: center;
            width: 100%;
            margin-top: 5px;
        }
        .advanced-controls-container {
            grid-column: 1 / 2;
            justify-self: start;
            display: flex;
            gap: 20px;
        }
        .player-controls {
            grid-column: 2 / 3;
            justify-self: center;
            display: flex;
            gap: 20px;
        }
        .player-controls button {
            background: none; border: none; font-size: 2.2rem;
            cursor: pointer; color: var(--text-primary);
        }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group label { font-size: 0.9rem; }
        .control-group select, .control-group input {
            padding: 6px 8px; border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.85rem;
        }
        .control-group input[type="number"] { width: 60px; }

        .loading-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center; align-items: center;
            z-index: 1000;
            font-size: 1.5rem; font-weight: 700;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div id="loadingText"></div>
    </div>

    <div class="top-section">
        <header class="header">
            <div class="header-top-row">
                <select id="hizbSelector"></select>
                <button id="downloadHizbBtn">تحميل الحزب</button>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="ابحث في جميع الأحزاب...">
            </div>
        </header>
        <div class="athman-list-container">
            <ul class="athman-list" id="athmanList"></ul>
        </div>
    </div>

    <main class="main-content">
        <img id="quranImage" src="https://via.placeholder.com/800x1200/FFFFFF/2E86C1?text=موقع+القرآن+الكريم" alt="صفحة المصحف">
    </main>

    <footer class="player-container">
        <div id="currentThumnTitle">اختر ثمنًا للبدء</div>
        <div class="timeline-container">
            <span class="time-display" id="currentTime">0:00</span>
            <input type="range" id="timeline" value="0" step="1" style="width: 100%;">
            <span class="time-display" id="totalTime">0:00</span>
        </div>
        <div class="all-controls-grid">
            <div class="advanced-controls-container">
                <div class="control-group">
                    <label for="speedControl">السرعة:</label>
                    <select id="speedControl">
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>عادية</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                    </select>
                </div>
            </div>
            <div class="player-controls">
                <button id="prevBtn" title="الثمن السابق">⏮</button>
                <button id="playPauseBtn" title="تشغيل/إيقاف">⏯</button>
                <button id="nextBtn" title="الثمن التالي">⏭</button>
            </div>
             <div class="advanced-controls-container" style="justify-content: flex-end;">
                 <div class="control-group">
                    <label for="repeatCount">التكرار:</label>
                    <input type="number" id="repeatCount" min="1" value="1">
                </div>
            </div>
        </div>
    </footer>

    <audio id="audioPlayer" style="display:none;"></audio>

    <script>
        // DOM Elements
        const hizbSelector = document.getElementById('hizbSelector');
        const athmanList = document.getElementById('athmanList');
        const searchInput = document.getElementById('searchInput');
        const quranImage = document.getElementById('quranImage');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const speedControl = document.getElementById('speedControl');
        const repeatCountInput = document.getElementById('repeatCount');
        const currentThumnTitle = document.getElementById('currentThumnTitle');
        const timeline = document.getElementById('timeline');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const downloadHizbBtn = document.getElementById('downloadHizbBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        
        // GitHub & Data
        const GITHUB_USER = "abuabdalaala";
        const GITHUB_REPO = "quran_nayhy";
        const GITHUB_BRANCH = "main";
        const GITHUB_RAW_BASE_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/`;

        const quranData = [
            {
                hizb_number: 1,
                hizb_name: "الحزب 01- الفاتحة",
                athman: [
                    { title: "001- الحمد لله رب العالمين", audio_file: "thumn_001.mp3", image_file: "thumn_001.jpg" },
                    { title: "002- وإذا لقوا الذين آمنوا قالوا آمنا...", audio_file: "thumn_002.mp3", image_file: "thumn_002.jpg" },
                    { title: "003- إن الله لا يستحيي أن يضرب مثلا...", audio_file: "thumn_003.mp3", image_file: "thumn_003.jpg" },
                    { title: "004- وإذ قلنا للملائكة اسجدوا لآدم...", audio_file: "thumn_004.mp3", image_file: "thumn_004.jpg" },
                    { title: "005- أتأمرون الناس بالبر وتنسون أنفسكم...", audio_file: "thumn_005.mp3", image_file: "thumn_005.jpg" },
                    { title: "006- وإذ قال موسى لقومه يا قوم...", audio_file: "thumn_006.mp3", image_file: "thumn_006.jpg" },
                    { title: "007- وإذ استسقى موسى لقومه فقلنا...", audio_file: "thumn_007.mp3", image_file: "thumn_007.jpg" },
                    { title: "008- وإذ قال موسى لقومه إن الله يأمركم...", audio_file: "thumn_008.mp3", image_file: "thumn_008.jpg" }
                ]
            },
            {
                hizb_number: 2,
                hizb_name: "الحزب 02- وإذا لقوا الذين ءامنوا",
                athman: [
                    { title: "009- وإذا لقوا الذين آمنوا قالوا آمنا وإذا خلا بعضهم إلى بعض قالوا أتحدثونهم", audio_file: "thumn_009.mp3", image_file: "thumn_009.jpg" },
                    { title: "010- وإن يأتوكم أسارى تفادوهم وهو محرم عليكم إخراجهم", audio_file: "thumn_010.mp3", image_file: "thumn_010.jpg" },
                    { title: "011- ولقد جاءكم موسى بالبينات ثم اتخذتم العجل من بعده وأنتم ظالمون", audio_file: "thumn_011.mp3", image_file: "thumn_011.jpg" },
                    { title: "012- واتبعوا ما تتلوا الشياطين على ملك سليمان وما كفر سليمان", audio_file: "thumn_012.mp3", image_file: "thumn_012.jpg" },
                    { title: "013- ما ننسخ من آية أو ننسها نأت بخير منها أو مثلها", audio_file: "thumn_013.mp3", image_file: "thumn_013.jpg" },
                    { title: "014- ولله المشرق والمغرب فأينما تولوا فثم وجه الله", audio_file: "thumn_014.mp3", image_file: "thumn_014.jpg" },
                    { title: "015- وإذ ابتلى إبراهيم ربه بكلمات فأتمهن", audio_file: "thumn_015.mp3", image_file: "thumn_015.jpg" },
                    { title: "016- أم كنتم شهداء إذ حضر يعقوب الموت إذ قال لبنيه", audio_file: "thumn_016.mp3", image_file: "thumn_016.jpg" }
                ]
            }
        ];

        // State
        let currentHizbIndex = 0;
        let currentThumnIndex = -1;
        let isPlaying = false;
        
        function populateHizbSelector() {
            hizbSelector.innerHTML = '';
            quranData.forEach((hizb, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = hizb.hizb_name;
                hizbSelector.appendChild(option);
            });
            hizbSelector.value = currentHizbIndex;
        }
        
        function populateAthmanListForHizb(hizbIndex) {
            const hizb = quranData[hizbIndex];
            athmanList.innerHTML = '';
            hizb.athman.forEach((thumn, thumnIndex) => {
                const li = document.createElement('li');
                li.className = 'athman-list-item';
                li.dataset.hizbIndex = hizbIndex;
                li.dataset.thumnIndex = thumnIndex;
                li.textContent = thumn.title.substring(0, 3); // Display only number
                li.title = thumn.title;
                
                li.addEventListener('click', () => {
                    currentHizbIndex = hizbIndex;
                    currentThumnIndex = thumnIndex;
                    loadThumn(true);
                });
                athmanList.appendChild(li);
            });
            updateActiveListItem();
        }

        function loadThumn(playImmediately = false) {
            if (currentHizbIndex < 0 || currentThumnIndex < 0) return;
            
            const hizb = quranData[currentHizbIndex];
            const thumn = hizb.athman[currentThumnIndex];

            populateHizbSelector(); 
            if (searchInput.value === '') { 
                populateAthmanListForHizb(currentHizbIndex);
            }
            currentThumnTitle.textContent = thumn.title;
            
            const hizbFolder = `hizb_${String(hizb.hizb_number).padStart(2, '0')}`;
            const audioPath = `audio/audio/${hizbFolder}/${encodeURIComponent(thumn.audio_file)}`;
            const imagePath = `images/${hizbFolder}/${encodeURIComponent(thumn.image_file)}`;

            audioPlayer.src = GITHUB_RAW_BASE_URL + audioPath;
            quranImage.src = GITHUB_RAW_BASE_URL + imagePath;

            if (playImmediately) {
                audioPlayer.play().catch(e => {
                    console.error("Audio Playback Error:", e);
                    currentThumnTitle.textContent = "خطأ: لم يتم العثور على الملف الصوتي";
                });
            }
        }

        function handleSearch(query) {
            if (!query) {
                populateAthmanListForHizb(currentHizbIndex);
                return;
            }
            let searchResults = [];
            quranData.forEach((hizb, hizbIndex) => {
                hizb.athman.forEach((thumn, thumnIndex) => {
                    if (thumn.title.includes(query)) {
                        searchResults.push({
                            title: `(${hizb.hizb_name.substring(0,9)}) ${thumn.title}`,
                            hizbIndex,
                            thumnIndex
                        });
                    }
                });
            });

            athmanList.innerHTML = '';
            searchResults.forEach(item => {
                const li = document.createElement('li');
                li.className = 'athman-list-item';
                li.textContent = item.title;
                li.addEventListener('click', () => {
                    currentHizbIndex = item.hizbIndex;
                    currentThumnIndex = item.thumnIndex;
                    loadThumn(true);
                });
                athmanList.appendChild(li);
            });
        }
        
        function updateActiveListItem() {
            const listItems = athmanList.querySelectorAll('.athman-list-item');
            listItems.forEach(item => {
                const hizbIdx = parseInt(item.dataset.hizbIndex);
                const thumnIdx = parseInt(item.dataset.thumnIndex);
                if (hizbIdx === currentHizbIndex && thumnIdx === currentThumnIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        async function downloadHizbAsZip() {
            loadingText.textContent = "جاري تحضير الملفات... الرجاء الانتظار.";
            loadingOverlay.style.display = 'flex';
            
            const hizb = quranData[currentHizbIndex];
            const zip = new JSZip();
            const promises = [];

            hizb.athman.forEach(thumn => {
                const hizbFolder = `hizb_${String(hizb.hizb_number).padStart(2, '0')}`;
                const url = `${GITHUB_RAW_BASE_URL}audio/audio/${hizbFolder}/${encodeURIComponent(thumn.audio_file)}`;
                
                const promise = fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to fetch ${thumn.audio_file}`);
                        return response.blob();
                    })
                    .then(blob => {
                        const newFilename = `${thumn.title}.mp3`;
                        zip.file(newFilename, blob);
                    })
                    .catch(error => console.error(error));
                promises.push(promise);
            });
            
            try {
                await Promise.all(promises);
                loadingText.textContent = "جاري ضغط الملفات...";
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, `${hizb.hizb_name}.zip`);
            } catch (error) {
                loadingText.textContent = "حدث خطأ أثناء تحميل الملفات.";
            } finally {
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 2000);
            }
        }

        // --- Event Listeners ---
        hizbSelector.addEventListener('change', (e) => {
            searchInput.value = '';
            currentHizbIndex = parseInt(e.target.value);
            currentThumnIndex = -1; 
            populateAthmanListForHizb(currentHizbIndex);
            currentThumnTitle.textContent = 'اختر ثمنًا من الشريط أعلاه';
        });
        
        searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
        downloadHizbBtn.addEventListener('click', downloadHizbAsZip);

        playPauseBtn.addEventListener('click', () => {
            if (currentThumnIndex < 0) { 
                currentThumnIndex = 0;
                loadThumn(true);
                return;
            }
            if (audioPlayer.paused) { audioPlayer.play(); } else { audioPlayer.pause(); }
        });
        
        audioPlayer.addEventListener('play', () => { isPlaying = true; playPauseBtn.textContent = '⏸'; });
        audioPlayer.addEventListener('pause', () => { isPlaying = false; playPauseBtn.textContent = '⏯'; });
        
        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                timeline.value = audioPlayer.currentTime;
                currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            }
        });
        audioPlayer.addEventListener('loadedmetadata', () => {
             timeline.max = audioPlayer.duration;
             totalTimeEl.textContent = formatTime(audioPlayer.duration);
        });

        timeline.addEventListener('input', () => { audioPlayer.currentTime = timeline.value; });

        function playNext() {
            currentThumnIndex++;
            if (currentThumnIndex >= quranData[currentHizbIndex].athman.length) {
                currentThumnIndex = 0;
            }
            loadThumn(isPlaying);
        }

        function playPrev() {
            currentThumnIndex--;
            if (currentThumnIndex < 0) {
                currentThumnIndex = quranData[currentHizbIndex].athman.length - 1;
            }
            loadThumn(isPlaying);
        }

        nextBtn.addEventListener('click', playNext);
        prevBtn.addEventListener('click', playPrev);

        speedControl.addEventListener('change', (e) => audioPlayer.playbackRate = parseFloat(e.target.value));

        audioPlayer.addEventListener('ended', () => {
            let repeatCount = parseInt(repeatCountInput.value, 10);
            if (repeatCount > 1) {
                repeatCountInput.value = repeatCount - 1;
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                playNext();
            }
        });
        
        // --- Initial Load ---
        function init() {
            populateHizbSelector();
            populateAthmanListForHizb(currentHizbIndex);
        }

        init();
    </script>
</body>
</html>
